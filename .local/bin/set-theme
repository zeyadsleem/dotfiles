#!/bin/bash

THEME_NAME=$1
THEMES_DIR="$HOME/dotfiles/.config/themes"
CURRENT_LINK="$THEMES_DIR/current"

if [ -z "$THEME_NAME" ]; then
    echo "Usage: set-theme <theme_name>"
    exit 1
fi

if [ ! -d "$THEMES_DIR/$THEME_NAME" ]; then
    notify-send "Theme Error" "Theme '$THEME_NAME' not found!" -u critical
    exit 1
fi

# 1. Update Symlink
ln -sfn "$THEMES_DIR/$THEME_NAME" "$CURRENT_LINK"

# 2. Update WezTerm Colors
if [ -f "$CURRENT_LINK/wezterm/colors.lua" ]; then
    ln -sf "$CURRENT_LINK/wezterm/colors.lua" "$HOME/.config/wezterm/colors.lua"
fi

# 3. Update Wallpaper
# We look for wallpaper.jpg or wallpaper.png inside the theme folder
WP=$(find "$CURRENT_LINK" -maxdepth 1 -name "wallpaper.*" | head -n 1)
if [ -n "$WP" ]; then
    # Using swaybg to set wallpaper (you can also use azotebg)
    pkill swaybg
    swaybg -i "$WP" -m fill &
    # Save for persistence if needed
    echo "$WP" > "$HOME/.cache/current_wallpaper"
fi

# 4. Update Waybar Colors
if [ -f "$CURRENT_LINK/waybar/colors.css" ]; then
    ln -sf "$CURRENT_LINK/waybar/colors.css" "$HOME/.config/waybar/colors.css"
fi

# 5. Update SwayNC (Notifications)
if [ -f "$CURRENT_LINK/swaync/style.css" ]; then
    ln -sf "$CURRENT_LINK/swaync/style.css" "$HOME/.config/swaync/theme.css"
    swaync-client -R && swaync-client -rs
fi

# 6. Apply GTK Theme
if [ -f "$CURRENT_LINK/gtk_theme_name" ]; then
    GTK_THEME=$(cat "$CURRENT_LINK/gtk_theme_name")
    gsettings set org.gnome.desktop.interface gtk-theme "$GTK_THEME"
    sed -i "s/gtk-theme-name=.*/gtk-theme-name=$GTK_THEME/" ~/.config/gtk-3.0/settings.ini
fi

# 7. Reload Sway & Waybar
swaymsg reload 2>/dev/null
pkill -USR2 waybar

# 8. Tmux Integration
if pgrep tmux >/dev/null; then
    tmux source-file ~/.tmux.conf
fi

notify-send "Theme Applied" "System switched to $THEME_NAME" -i display